<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buscador Centroam√©rica - Instant√°neo</title>
    <style>
        :root {
            --blue-sky: #70c4f4;
            --granite: #B7B8B6;
            --pine: #34675C;
            --soft-mint: #98FFD9;
            --bg-dark: #1a1a1a;
            --card-bg: #262626;
            --warning: #FFB74D;
            --success: #4CAF50;
            --telegram-blue: #0088cc;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: white;
            margin: 0; 
            padding: 10px;
            display: flex; 
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container { 
            width: 100%; 
            max-width: 100%;
            box-sizing: border-box;
        }

        .header { 
            text-align: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px;
            border-bottom: 2px solid var(--pine);
        }
        
        .header h1 { 
            font-size: 20px; 
            margin: 0; 
            color: var(--blue-sky); 
            font-weight: 800; 
            letter-spacing: 0.5px; 
        }
        
        .header p { 
            font-size: 13px; 
            color: var(--soft-mint); 
            font-weight: 600; 
            margin-top: 5px; 
            opacity: 0.9; 
        }

        /* BANDERAS DE PA√çSES - COMPACTAS */
        .countries-flags {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .country-flag {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 10px;
            border-radius: 8px;
            background: var(--card-bg);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 70px;
            max-width: 90px;
            flex: 1;
        }

        .country-flag.active {
            border-color: var(--soft-mint);
            background: rgba(152, 255, 217, 0.1);
            transform: translateY(-2px);
        }

        .flag-emoji {
            font-size: 24px;
            margin-bottom: 3px;
        }

        .country-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--granite);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .country-flag.active .country-name {
            color: var(--soft-mint);
        }

        /* B√öSQUEDA */
        .search-section {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 2px solid var(--pine);
            background: var(--card-bg);
            color: white;
            font-size: 15px;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: var(--soft-mint);
            box-shadow: 0 0 12px rgba(152, 255, 217, 0.2);
        }

        .search-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 11px;
        }

        .current-country {
            background: var(--pine);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cache-status {
            color: var(--soft-mint);
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
        }

        /* BOT√ìN MAPS - RESTAURADO */
        .map-search-section {
            margin: 15px 0;
            text-align: center;
        }

        .map-search-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--pine);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .map-search-btn:hover {
            background: #2a564d;
            transform: translateY(-2px);
        }

        /* FILTROS R√ÅPIDOS */
        .quick-filters {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-filter {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--pine);
            color: var(--soft-mint);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
        }

        .quick-filter:hover {
            background: var(--pine);
            color: white;
        }

        /* RESULTADOS */
        .results-list { 
            margin-top: 15px; 
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .results-list::-webkit-scrollbar {
            width: 6px;
        }

        .results-list::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 3px;
        }

        .results-list::-webkit-scrollbar-thumb {
            background: var(--pine);
            border-radius: 3px;
        }

        .location-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--pine);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .location-card:hover { 
            transform: translateX(3px); 
            border-left-color: var(--soft-mint);
        }

        .location-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .location-type {
            background: var(--pine);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .location-country {
            background: rgba(255, 255, 255, 0.1);
            color: var(--soft-mint);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .place-name { 
            font-size: 16px; 
            font-weight: 800; 
            color: var(--blue-sky); 
            display: block; 
            margin-bottom: 8px; 
        }

        .location-hierarchy {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }

        .hierarchy-item {
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .hierarchy-label {
            color: var(--soft-mint);
            font-weight: 600;
            min-width: 90px;
        }

        .hierarchy-value {
            color: white;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .coordinates-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .coords-display {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: var(--granite);
            background: rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .btn-copy {
            background: var(--soft-mint);
            color: var(--bg-dark);
        }

        .btn-copy:hover {
            background: white;
        }

        .btn-copy.success {
            background: var(--blue-sky);
            color: white;
        }

        .btn-map {
            background: var(--pine);
            color: white;
        }

        .btn-map:hover {
            background: #2a564d;
        }

        /* ESTADOS */
        .no-results {
            text-align: center;
            padding: 40px 15px;
            color: var(--granite);
        }

        .no-results-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .searching {
            text-align: center;
            padding: 30px 15px;
            color: var(--soft-mint);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid var(--pine);
            border-top: 3px solid var(--soft-mint);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-stats {
            font-size: 12px;
            color: var(--granite);
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            display: none;
        }

        /* BOT√ìN FLOTANTE */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success), var(--blue-sky));
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        /* MODAL - M√ÅS COMPACTO */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 1001;
            overflow-y: auto;
            padding: 20px 10px;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            border: 2px solid var(--pine);
            animation: slideUp 0.3s ease;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--pine);
            padding-bottom: 12px;
        }

        .modal-title {
            color: var(--soft-mint);
            font-size: 18px;
            font-weight: 800;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--granite);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .close-modal:hover {
            color: var(--soft-mint);
        }

        /* FORMULARIO SIMPLIFICADO */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: var(--soft-mint);
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 700;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--pine);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--soft-mint);
        }

        .form-help {
            font-size: 11px;
            color: var(--granite);
            margin-top: 5px;
            display: block;
        }

        /* ELIMINADO: Campos din√°micos por pa√≠s */

        .detected-info {
            margin: 15px 0;
        }

        .detected-card {
            background: rgba(52, 103, 92, 0.1);
            border: 1px solid var(--pine);
            border-radius: 8px;
            padding: 12px;
        }

        .detected-card strong {
            color: var(--soft-mint);
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .detected-card span {
            font-size: 12px;
            color: white;
            line-height: 1.5;
        }

        .loading-detection {
            text-align: center;
            padding: 15px;
            color: var(--soft-mint);
        }

        .loading-detection .loader-small {
            width: 20px;
            height: 20px;
            border: 2px solid var(--pine);
            border-top: 2px solid var(--soft-mint);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            color: var(--soft-mint);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.5s ease;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            flex: 2;
            padding: 12px;
            background: var(--telegram-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #0077b5;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: var(--card-bg);
            color: var(--granite);
            border: 1px solid var(--pine);
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: var(--pine);
            color: white;
        }

        /* RESPONSIVE PARA PANTALLAS PEQUE√ëAS */
        @media (max-width: 480px) {
            body { padding: 8px; }
            
            .header h1 { font-size: 18px; }
            .header p { font-size: 12px; }
            
            .country-flag {
                min-width: 60px;
                padding: 6px 8px;
            }
            
            .flag-emoji { font-size: 20px; }
            .country-name { font-size: 10px; }
            
            .search-input { padding: 12px 14px; font-size: 14px; }
            
            .location-card { padding: 12px; }
            .place-name { font-size: 15px; }
            
            .coordinates-row {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-action {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                padding: 15px;
                margin-top: 10px;
            }
            
            .modal-title { font-size: 16px; }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
            }
            
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 22px;
                bottom: 15px;
                right: 15px;
            }
        }

        /* PARA PANTALLAS MUY ALTAS */
        @media (min-height: 800px) {
            .results-list {
                max-height: 500px;
            }
        }

        /* PARA PANTALLAS CORTAS */
        @media (max-height: 600px) {
            .results-list {
                max-height: 250px;
            }
            
            .modal-overlay {
                align-items: flex-start;
                padding-top: 10px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üìç Buscador Centroam√©rica</h1>
        <p>Encuentra direcciones en Centroam√©rica</p>
    </div>

    <!-- BANDERAS DE PA√çSES -->
    <div class="countries-flags" id="countriesFlags">
        <!-- Se llenar√° con JavaScript -->
    </div>

    <!-- B√öSQUEDA -->
    <div class="search-section">
        <input type="text" id="mainSearch" class="search-input" 
               placeholder="Buscar colonia, barrio, municipio...">
        <div class="search-info">
            <div class="current-country" id="currentCountry">
                <span id="currentFlag">üá≠üá≥</span>
                <span id="currentCountryName">Honduras</span>
            </div>
            <div class="cache-status" id="cacheStatus">
                Cargando...
            </div>
        </div>
    </div>

    <!-- FILTROS R√ÅPIDOS -->
    <div class="quick-filters" id="quickFilters"></div>

    <!-- BOT√ìN MAPS - RESTAURADO -->
    <div class="map-search-section">
        <button class="map-search-btn" id="openMapsBtn">
            <span>üó∫Ô∏è ¬øNo est√° lo que buscabas? Abrir en Maps</span>
        </button>
    </div>

    <!-- RESULTADOS -->
    <div id="resultsContainer" class="results-list"></div>
    
    <!-- ESTAD√çSTICAS -->
    <div id="resultsStats" class="results-stats"></div>
</div>

<!-- BOT√ìN FLOTANTE -->
<button class="floating-btn" id="openModalBtn">+</button>

<!-- MODAL SIMPLIFICADO -->
<div class="modal-overlay" id="addLocationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üìç Agregar Nueva Direcci√≥n</h3>
            <button class="close-modal" id="closeModalBtn">&times;</button>
        </div>
        
        <form id="locationForm">
            <!-- PA√çS -->
            <div class="form-group">
                <label class="form-label">Pa√≠s:</label>
                <select class="form-select" id="locationCountry">
                    <option value="HN">üá≠üá≥ Honduras</option>
                    <option value="SV">üá∏üáª El Salvador</option>
                    <option value="CR">üá®üá∑ Costa Rica</option>
                    <option value="PA">üáµüá¶ Panam√°</option>
                </select>
            </div>
            
            <!-- COORDENADAS -->
            <div class="form-group">
                <label class="form-label">Coordenadas (latitud, longitud):</label>
                <input type="text" class="form-input" id="locationCoords" 
                       placeholder="Ej: 15.527522, -88.061812" required>
                <span class="form-help">
                    En Google Maps: Haz clic derecho ‚Üí "¬øQu√© hay aqu√≠?" ‚Üí Copia los n√∫meros
                </span>
            </div>
            
            <!-- NOMBRE -->
            <div class="form-group">
                <label class="form-label">Nombre del lugar:</label>
                <input type="text" class="form-input" id="locationName" 
                       placeholder="Ej: Mi casa, Colonia Los √Ångeles, Centro Comercial...">
                <span class="form-help">
                    Si no pones nombre, usaremos el detectado autom√°ticamente
                </span>
            </div>
            
            <!-- TIPO (opcional) -->
            <div class="form-group">
                <label class="form-label">Tipo de lugar (opcional):</label>
                <select class="form-select" id="locationType">
                    <option value="">Seleccionar tipo...</option>
                    <option value="colonia">Colonia</option>
                    <option value="barrio">Barrio</option>
                    <option value="aldea">Aldea</option>
                    <option value="caserio">Caser√≠o</option>
                    <option value="municipio">Municipio</option>
                    <option value="ciudad">Ciudad</option>
                    <option value="punto_interes">Punto de Inter√©s</option>
                </select>
            </div>
            
            <!-- INFORMACI√ìN DETECTADA (se llena autom√°ticamente) -->
            <div class="detected-info" id="detectedInfo" style="display: none;">
                <div class="detected-card">
                    <strong>‚úÖ Informaci√≥n detectada:</strong>
                    <span id="detectedAddress">Cargando...</span>
                </div>
            </div>
            
            <!-- MENSAJE DE √âXITO -->
            <div class="success-message" id="successMessage">
                ‚úÖ Solicitud enviada para aprobaci√≥n
            </div>
            
            <!-- BOTONES -->
            <div class="form-buttons">
                <button type="button" class="btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="button" class="btn-secondary" id="detectBtn" style="background: var(--pine);">
                    üîç Detectar Direcci√≥n
                </button>
                <button type="submit" class="btn-primary" id="submitBtn">
                    üì§ Enviar Solicitud
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // ========== CONFIGURACI√ìN ==========
    const TELEGRAM_CHAT_ID = '5770086010';
    const BACKEND_URL = 'https://direccionesslv-izev.onrender.com';
    const GITHUB_USER = 'Miller1313';
    const GITHUB_REPO = 'direccionesSLV';

    // ========== CONFIGURACI√ìN DE PA√çSES ==========
    const COUNTRIES = {
        'HN': {
            name: 'Honduras',
            emoji: 'üá≠üá≥',
            code: 'hn',
            bounds: [-89.5, 12.0, -83.0, 17.0],
            searchPrefix: 'Honduras'
        },
        'SV': {
            name: 'El Salvador',
            emoji: 'üá∏üáª',
            code: 'sv',
            bounds: [-90.0, 13.0, -87.5, 14.5],
            searchPrefix: 'El Salvador'
        },
        'CR': {
            name: 'Costa Rica',
            emoji: 'üá®üá∑',
            code: 'cr',
            bounds: [-86.0, 8.0, -82.5, 11.5],
            searchPrefix: 'Costa Rica'
        },
        'PA': {
            name: 'Panam√°',
            emoji: 'üáµüá¶',
            code: 'pa',
            bounds: [-83.0, 7.0, -77.0, 10.0],
            searchPrefix: 'Panam√°'
        }
    };

    // ========== VARIABLES GLOBALES ==========
    let selectedCountry = 'HN';
    const searchCache = new Map();
    const CACHE_DURATION = 24 * 60 * 60 * 1000;
    let localDatabase = {};
    let searchTimeout;
    let isSearching = false;
    let detectedData = {};

    // ========== INICIALIZACI√ìN ==========
    async function initializeApp() {
        loadCacheFromStorage();
        createCountryFlags();
        await loadDatabaseFromGitHub();
        showEmptyState();
        updateQuickFilters();
        setupEventListeners();
        
        console.log('üöÄ Aplicaci√≥n inicializada');
    }

    // ========== BANDERAS DE PA√çSES ==========
    function createCountryFlags() {
        const container = document.getElementById('countriesFlags');
        container.innerHTML = '';
        
        Object.entries(COUNTRIES).forEach(([code, country]) => {
            const flagHTML = `
                <div class="country-flag ${code === selectedCountry ? 'active' : ''}" 
                     data-country="${code}"
                     onclick="selectCountry('${code}')">
                    <div class="flag-emoji">${country.emoji}</div>
                    <div class="country-name">${country.name}</div>
                </div>
            `;
            container.innerHTML += flagHTML;
        });
        
        updateCurrentCountryDisplay();
    }

    function selectCountry(countryCode) {
        selectedCountry = countryCode;
        
        // Actualizar banderas
        document.querySelectorAll('.country-flag').forEach(flag => {
            flag.classList.remove('active');
            if (flag.dataset.country === countryCode) {
                flag.classList.add('active');
            }
        });
        
        // Actualizar display
        updateCurrentCountryDisplay();
        
        // Actualizar filtros
        updateQuickFilters();
        
        // Si hay b√∫squeda activa, ejecutarla de nuevo
        const currentQuery = document.getElementById('mainSearch').value.trim();
        if (currentQuery.length >= 2) {
            performSearch(currentQuery);
        } else {
            showEmptyState();
        }
    }

    function updateCurrentCountryDisplay() {
        const country = COUNTRIES[selectedCountry];
        document.getElementById('currentFlag').textContent = country.emoji;
        document.getElementById('currentCountryName').textContent = country.name;
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
        // B√∫squeda
        document.getElementById('mainSearch').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                showEmptyState();
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 400);
        });
        
        // Bot√≥n Maps
        document.getElementById('openMapsBtn').addEventListener('click', function() {
            const query = document.getElementById('mainSearch').value.trim();
            const country = COUNTRIES[selectedCountry];
            const searchQuery = query ? `${query} ${country.name}` : country.name;
            const url = `https://www.google.com/maps/search/${encodeURIComponent(searchQuery)}`;
            window.open(url, '_blank');
        });
        
        // Modal
        const modal = document.getElementById('addLocationModal');
        const openBtn = document.getElementById('openModalBtn');
        const closeBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const form = document.getElementById('locationForm');
        const detectBtn = document.getElementById('detectBtn');
        
        openBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
            form.reset();
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('detectedInfo').style.display = 'none';
            detectedData = {};
        });
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        
        // Detectar direcci√≥n
        detectBtn.addEventListener('click', detectLocation);
        
        // Enviar formulario
        form.addEventListener('submit', submitForm);
    }
    
    function closeModal() {
        document.getElementById('addLocationModal').style.display = 'none';
    }

    // ========== DETECCI√ìN DE UBICACI√ìN - CORREGIDA ==========
    async function detectLocation() {
        const coordsInput = document.getElementById('locationCoords').value.trim();
        
        if (!coordsInput) {
            alert('‚ö†Ô∏è Ingresa las coordenadas primero');
            return;
        }
        
        // Validar formato
        const coords = coordsInput.split(',').map(c => c.trim());
        if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
            alert('‚ùå Formato inv√°lido. Usa: latitud, longitud\nEj: 15.527522, -88.061812');
            return;
        }
        
        const lat = parseFloat(coords[0]);
        const lon = parseFloat(coords[1]);
        
        // Mostrar carga
        const detectedInfo = document.getElementById('detectedInfo');
        detectedInfo.innerHTML = `
            <div class="loading-detection">
                <div class="loader-small"></div>
                Detectando direcci√≥n...
            </div>
        `;
        detectedInfo.style.display = 'block';
        
        try {
            // Usar Nominatim para reverse geocoding
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?` +
                `lat=${lat}&lon=${lon}&` +
                `format=json&addressdetails=1&zoom=16&accept-language=es`
            );
            
            if (!response.ok) {
                throw new Error('Error en la API');
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const address = data.address || {};
            
            // Extraer informaci√≥n relevante
            let detectedText = '';
            const extractedData = {
                fullAddress: data.display_name,
                placeName: data.display_name.split(',')[0] || 'Ubicaci√≥n sin nombre'
            };
            
            // Agregar informaci√≥n seg√∫n lo disponible
            if (address.road) {
                detectedText += `<strong>Calle:</strong> ${address.road}<br>`;
                extractedData.road = address.road;
            }
            
            if (address.suburb || address.neighbourhood) {
                detectedText += `<strong>Barrio/Colonia:</strong> ${address.suburb || address.neighbourhood}<br>`;
                extractedData.area = address.suburb || address.neighbourhood;
            }
            
            if (address.city || address.town || address.village) {
                detectedText += `<strong>Ciudad/Pueblo:</strong> ${address.city || address.town || address.village}<br>`;
                extractedData.city = address.city || address.town || address.village;
            }
            
            if (address.state) {
                detectedText += `<strong>Estado/Departamento:</strong> ${address.state}<br>`;
                extractedData.state = address.state;
            }
            
            if (address.country) {
                detectedText += `<strong>Pa√≠s:</strong> ${address.country}`;
                extractedData.country = address.country;
            }
            
            if (!detectedText) {
                detectedText = `<strong>Ubicaci√≥n:</strong> ${data.display_name}`;
            }
            
            // Guardar datos
            detectedData = extractedData;
            
            // Actualizar interfaz
            document.getElementById('detectedAddress').innerHTML = detectedText;
            detectedInfo.innerHTML = `
                <div class="detected-card">
                    <strong>‚úÖ Informaci√≥n detectada:</strong>
                    <span id="detectedAddress">${detectedText}</span>
                </div>
            `;
            
            // Auto-completar nombre si est√° vac√≠o
            const nameInput = document.getElementById('locationName');
            if (!nameInput.value.trim() && detectedData.placeName) {
                nameInput.value = detectedData.placeName;
            }
            
        } catch (error) {
            console.error('Error en detecci√≥n:', error);
            
            // Mostrar mensaje amigable
            detectedInfo.innerHTML = `
                <div class="detected-card">
                    <strong>‚ö†Ô∏è Informaci√≥n limitada detectada</strong>
                    <span>No se pudo obtener informaci√≥n detallada. Puedes:</span>
                    <ul style="margin: 8px 0 0 20px; font-size: 11px;">
                        <li>Completar manualmente el nombre</li>
                        <li>Enviar igual para aprobaci√≥n manual</li>
                        <li>Intentar con otras coordenadas</li>
                    </ul>
                </div>
            `;
            
            // Datos m√≠nimos
            detectedData = {
                fullAddress: `Coordenadas: ${lat}, ${lon}`,
                placeName: 'Ubicaci√≥n por coordenadas'
            };
        }
    }

    // ========== ENV√çO DE FORMULARIO ==========
    async function submitForm(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '‚è≥ Enviando...';
        submitBtn.disabled = true;
        
        try {
            const locationData = {
                name: document.getElementById('locationName').value.trim(),
                coords: document.getElementById('locationCoords').value.trim(),
                type: document.getElementById('locationType').value || 'ubicacion',
                pais: document.getElementById('locationCountry').value
            };
            
            // Validar coordenadas
            const coords = locationData.coords.split(',').map(c => c.trim());
            if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
                throw new Error('Formato de coordenadas inv√°lido. Usa: latitud, longitud');
            }
            
            // Si no hay nombre, usar el detectado o uno gen√©rico
            if (!locationData.name && detectedData.placeName) {
                locationData.name = detectedData.placeName;
            } else if (!locationData.name) {
                locationData.name = 'Ubicaci√≥n sin nombre';
            }
            
            // Enviar al backend
            const result = await sendToBackend(locationData);
            
            if (result.success) {
                // Mostrar √©xito
                document.getElementById('successMessage').innerHTML = `
                    ‚úÖ <strong>Solicitud enviada</strong><br>
                    <small style="font-size: 11px;">
                        ID: ${result.data.request_id || 'N/A'}<br>
                        Revisa Telegram para aprobar
                    </small>
                `;
                document.getElementById('successMessage').style.display = 'block';
                submitBtn.innerHTML = '‚úÖ ¬°Enviado!';
                
                // Cerrar despu√©s de 2 segundos
                setTimeout(() => {
                    closeModal();
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }, 300);
                }, 2000);
                
            } else {
                throw new Error(result.error || 'Error al enviar');
            }
            
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    async function sendToBackend(locationData) {
        try {
            // Preparar datos finales
            const finalData = {
                name: locationData.name,
                coords: locationData.coords,
                type: locationData.type,
                pais: locationData.pais,
                detected: detectedData.fullAddress || 'No detectado autom√°ticamente'
            };
            
            console.log('üì§ Enviando:', finalData);
            
            const response = await fetch(`${BACKEND_URL}/send-notification`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    location: finalData,
                    telegram_chat_id: TELEGRAM_CHAT_ID
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                return {success: true, data: result};
            } else {
                const errorText = await response.text();
                return {success: false, error: `Error ${response.status}`};
            }
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            return {success: false, error: error.message};
        }
    }

    // ========== B√öSQUEDA ==========
    function normalizeQuery(query) {
        return query
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, '')
            .trim();
    }

    function searchLocalFast(query) {
        const normalized = normalizeQuery(query);
        const results = [];
        
        if (!localDatabase[selectedCountry]) {
            return results;
        }
        
        Object.entries(localDatabase[selectedCountry]).forEach(([key, location]) => {
            if (key.includes(normalized) || 
                (location.name && location.name.toLowerCase().includes(normalized))) {
                results.push({
                    ...location,
                    source: 'official',
                    score: key === normalized ? 100 : 50
                });
            }
        });
        
        return results.sort((a, b) => b.score - a.score);
    }

    async function searchAPI(query) {
        const cacheKey = `api_${selectedCountry}_${normalizeQuery(query)}`;
        
        if (searchCache.has(cacheKey)) {
            return searchCache.get(cacheKey);
        }
        
        try {
            const country = COUNTRIES[selectedCountry];
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?` +
                `q=${encodeURIComponent(query + ' ' + country.name)}` +
                `&format=json&addressdetails=1&limit=15&countrycodes=${country.code}` +
                `&dedupe=1`
            );
            
            if (!response.ok) throw new Error('API Error');
            
            const data = await response.json();
            const processed = processAPIData(data);
            
            searchCache.set(cacheKey, processed);
            saveCacheToStorage();
            updateCacheStatus();
            
            return processed;
        } catch (error) {
            console.error("API Error:", error);
            return [];
        }
    }

    function processAPIData(data) {
        return data.map(item => {
            const address = item.address || {};
            
            return {
                name: item.display_name.split(',')[0],
                type: item.type || 'ubicaci√≥n',
                lat: parseFloat(item.lat),
                lon: parseFloat(item.lon),
                full_address: item.display_name,
                source: 'api',
                importance: item.importance || 0,
                pais: selectedCountry,
                country_emoji: COUNTRIES[selectedCountry].emoji,
                // Info adicional si est√° disponible
                municipio: address.city || address.town || address.village || '',
                departamento: address.state || address.county || ''
            };
        });
    }

    async function performSearch(query) {
        if (isSearching) return;
        
        isSearching = true;
        showLoading();
        
        try {
            const localResults = searchLocalFast(query);
            const apiResults = await searchAPI(query);
            const allResults = [...localResults, ...apiResults];
            const uniqueResults = removeDuplicates(allResults);
            
            displayResults(uniqueResults);
            
            // Estad√≠sticas
            document.getElementById('resultsStats').innerHTML = `
                ${uniqueResults.length} resultados en ${COUNTRIES[selectedCountry].name}
            `;
            document.getElementById('resultsStats').style.display = 'block';
            
        } catch (error) {
            console.error('Error:', error);
            showError();
        } finally {
            isSearching = false;
        }
    }

    function removeDuplicates(results) {
        const seen = new Set();
        return results.filter(item => {
            const key = `${normalizeQuery(item.name)}_${item.lat.toFixed(4)}_${item.lon.toFixed(4)}`;
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        }).sort((a, b) => {
            const aScore = (a.source === 'official' ? 100 : 0) + (a.importance || 0);
            const bScore = (b.source === 'official' ? 100 : 0) + (b.importance || 0);
            return bScore - aScore;
        });
    }

    // ========== INTERFAZ DE RESULTADOS ==========
    function showLoading() {
        document.getElementById('resultsContainer').innerHTML = `
            <div class="searching">
                <div class="loader"></div>
                <div>Buscando en ${COUNTRIES[selectedCountry].name}...</div>
            </div>
        `;
    }

    function showEmptyState() {
        document.getElementById('resultsContainer').innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">üîç</div>
                <p>Escribe para buscar en ${COUNTRIES[selectedCountry].name}</p>
            </div>
        `;
        document.getElementById('resultsStats').style.display = 'none';
    }

    function showError() {
        document.getElementById('resultsContainer').innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">‚ö†Ô∏è</div>
                <p>Error en la b√∫squeda</p>
                <p style="font-size: 11px; color: var(--soft-mint); margin-top: 8px;">
                    Intenta nuevamente
                </p>
            </div>
        `;
    }

    function displayResults(results) {
        const container = document.getElementById('resultsContainer');
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">ü§î</div>
                    <p>No se encontraron resultados</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        results.forEach(location => {
            const mapUrl = `https://www.google.com/maps?q=${location.lat},${location.lon}`;
            
            html += `
                <div class="location-card" onclick="window.open('${mapUrl}', '_blank')">
                    <div class="location-card-header">
                        <span class="location-type">${location.type}</span>
                        <span class="location-country">
                            ${location.country_emoji || COUNTRIES[selectedCountry].emoji}
                            ${COUNTRIES[selectedCountry].name}
                        </span>
                    </div>
                    
                    <span class="place-name">
                        ${location.name}
                        ${location.source === 'official' ? '<span style="color: var(--success); margin-left: 6px;">‚ö°</span>' : ''}
                    </span>
                    
                    ${location.municipio || location.departamento ? `
                        <div class="location-hierarchy">
                            ${location.municipio ? `
                                <div class="hierarchy-item">
                                    <span class="hierarchy-label">Municipio:</span>
                                    <span class="hierarchy-value">${location.municipio}</span>
                                </div>
                            ` : ''}
                            
                            ${location.departamento ? `
                                <div class="hierarchy-item">
                                    <span class="hierarchy-label">Departamento:</span>
                                    <span class="hierarchy-value">${location.departamento}</span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <div class="coordinates-row">
                        <span class="coords-display">
                            üìç ${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}
                        </span>
                        
                        <div class="action-buttons">
                            <button class="btn-action btn-map" 
                                    onclick="event.stopPropagation(); window.open('${mapUrl}', '_blank')">
                                üó∫Ô∏è Maps
                            </button>
                            <button class="btn-action btn-copy" 
                                    onclick="event.stopPropagation(); copyCoords(${location.lat}, ${location.lon}, this)">
                                üìã Copiar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function copyCoords(lat, lon, button) {
        const text = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        navigator.clipboard.writeText(text).then(() => {
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ Copiado';
            button.classList.add('success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('success');
            }, 1500);
        });
    }

    // ========== FILTROS R√ÅPIDOS ==========
    function updateQuickFilters() {
        const filtersByCountry = {
            'HN': [
                {text: "Colonias", search: "Colonia"},
                {text: "Tegucigalpa", search: "Tegucigalpa"},
                {text: "SPS", search: "San Pedro Sula"}
            ],
            'SV': [
                {text: "San Salvador", search: "San Salvador"},
                {text: "Santa Ana", search: "Santa Ana"},
                {text: "Soyapango", search: "Soyapango"}
            ],
            'CR': [
                {text: "San Jos√©", search: "San Jos√©"},
                {text: "Alajuela", search: "Alajuela"},
                {text: "Heredia", search: "Heredia"}
            ],
            'PA': [
                {text: "Panam√°", search: "Panam√°"},
                {text: "Col√≥n", search: "Col√≥n"},
                {text: "David", search: "David"}
            ]
        };
        
        const container = document.getElementById('quickFilters');
        const filters = filtersByCountry[selectedCountry] || [];
        
        container.innerHTML = '';
        
        filters.forEach(filter => {
            const btn = document.createElement('button');
            btn.className = 'quick-filter';
            btn.textContent = filter.text;
            btn.onclick = () => {
                document.getElementById('mainSearch').value = filter.search;
                document.getElementById('mainSearch').dispatchEvent(new Event('input'));
            };
            container.appendChild(btn);
        });
    }

    // ========== CACHE ==========
    function loadCacheFromStorage() {
        try {
            const savedCache = localStorage.getItem('caSearchCache');
            if (savedCache) {
                const parsed = JSON.parse(savedCache);
                const now = Date.now();
                
                Object.entries(parsed).forEach(([key, data]) => {
                    if (now - data.timestamp < CACHE_DURATION) {
                        searchCache.set(key, data.results);
                    }
                });
            }
        } catch (e) {
            console.log("Error cache:", e);
        }
    }

    function saveCacheToStorage() {
        try {
            const cacheObj = {};
            const now = Date.now();
            
            searchCache.forEach((results, key) => {
                cacheObj[key] = {
                    results: results,
                    timestamp: now
                };
            });
            
            localStorage.setItem('caSearchCache', JSON.stringify(cacheObj));
        } catch (e) {
            console.log("Error guardando cache:", e);
        }
    }

    // ========== BASE DE DATOS ==========
    async function loadDatabaseFromGitHub() {
        try {
            const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/locations.json`);
            if (response.ok) {
                const data = await response.json();
                localDatabase = data;
                updateCacheStatus();
            } else {
                initializeEmptyDatabase();
            }
        } catch (error) {
            console.error('Error BD:', error);
            initializeEmptyDatabase();
        }
    }

    function initializeEmptyDatabase() {
        localDatabase = {};
        Object.keys(COUNTRIES).forEach(country => {
            localDatabase[country] = {};
        });
    }

    function updateCacheStatus() {
        let totalLocations = 0;
        Object.keys(localDatabase).forEach(country => {
            totalLocations += Object.keys(localDatabase[country] || {}).length;
        });
        
        document.getElementById('cacheStatus').textContent = 
            `${searchCache.size} cache ‚Ä¢ ${totalLocations} loc`;
    }

    // ========== FUNCIONES GLOBALES ==========
    window.selectCountry = selectCountry;
    window.copyCoords = copyCoords;
    
    window.refreshDatabase = async function() {
        await loadDatabaseFromGitHub();
        const currentQuery = document.getElementById('mainSearch').value.trim();
        if (currentQuery.length >= 2) {
            performSearch(currentQuery);
        }
        alert('‚úÖ Base actualizada');
    };

    // ========== INICIAR ==========
    initializeApp();
</script>
</body>
</html>