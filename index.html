<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Honduras - Instant√°neo</title>
    <style>
        :root {
            --blue-sky: #70c4f4;
            --granite: #B7B8B6;
            --pine: #34675C;
            --soft-mint: #98FFD9;
            --bg-dark: #1a1a1a;
            --card-bg: #262626;
            --warning: #FFB74D;
            --success: #4CAF50;
            --telegram-blue: #0088cc;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: white;
            margin: 0; 
            padding: 15px;
            display: flex; 
            justify-content: center;
            min-height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 700px; 
        }

        .header { 
            text-align: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 2px solid var(--pine);
        }
        
        .header h1 { 
            font-size: 22px; 
            margin: 0; 
            color: var(--blue-sky); 
            font-weight: 800; 
            letter-spacing: 0.5px; 
        }
        
        .header p { 
            font-size: 13px; 
            color: var(--soft-mint); 
            font-weight: 600; 
            margin-top: 5px; 
            opacity: 0.9; 
        }

        .search-section {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 14px 18px;
            border-radius: 10px;
            border: 2px solid var(--pine);
            background: var(--card-bg);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: var(--soft-mint);
            box-shadow: 0 0 12px rgba(152, 255, 217, 0.2);
        }

        .search-input::placeholder {
            color: var(--granite);
            opacity: 0.7;
        }

        .search-info {
            font-size: 12px;
            color: var(--soft-mint);
            text-align: right;
            margin-top: 5px;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cache-indicator {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            opacity: 0.8;
        }

        .results-list { 
            margin-top: 15px; 
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .results-list::-webkit-scrollbar {
            width: 6px;
        }

        .results-list::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 3px;
        }

        .results-list::-webkit-scrollbar-thumb {
            background: var(--pine);
            border-radius: 3px;
        }

        .location-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
            border-left: 4px solid var(--pine);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .location-card:hover { 
            transform: translateX(3px); 
            border-left-color: var(--soft-mint);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .location-card.repeated {
            border-left-color: var(--warning);
        }

        .location-type {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--pine);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .location-card.repeated .location-type {
            background: var(--warning);
            color: var(--bg-dark);
        }

        .place-name { 
            font-size: 17px; 
            font-weight: 700; 
            color: var(--blue-sky); 
            display: block; 
            margin-bottom: 8px; 
            padding-right: 80px;
        }

        .location-card.repeated .place-name {
            color: var(--warning);
        }

        .location-hierarchy {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }

        .hierarchy-item {
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .hierarchy-label {
            color: var(--soft-mint);
            font-weight: 600;
            min-width: 100px;
        }

        .hierarchy-value {
            color: white;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .coordinates-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .coords-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--granite);
            background: rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 7px 12px;
            border-radius: 8px;
            border: none;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .btn-copy {
            background: var(--soft-mint);
            color: var(--bg-dark);
        }

        .btn-copy:hover {
            background: white;
            transform: scale(1.05);
        }

        .btn-copy.success {
            background: var(--blue-sky);
            color: white;
        }

        .btn-map {
            background: var(--pine);
            color: white;
        }

        .btn-map:hover {
            background: #2a564d;
        }

        .warning-note {
            background: rgba(255, 183, 77, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--granite);
        }

        .no-results-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .searching {
            text-align: center;
            padding: 20px;
            color: var(--soft-mint);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid var(--pine);
            border-top: 3px solid var(--soft-mint);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-stats {
            font-size: 12px;
            color: var(--granite);
            text-align: center;
            margin-top: 15px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-filter {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--pine);
            color: var(--soft-mint);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-filter:hover {
            background: var(--pine);
            color: white;
        }

        .map-search-link {
            display: block;
            text-align: center;
            padding: 15px;
            color: var(--soft-mint);
            text-decoration: none;
            border-radius: 10px;
            border: 1px dashed var(--pine);
            margin-top: 20px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .map-search-link:hover {
            border-color: var(--soft-mint);
            color: var(--soft-mint);
            background: rgba(152, 255, 217, 0.05);
        }

        /* NUEVOS ESTILOS PARA EL SISTEMA DE AGREGAR */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success), var(--blue-sky));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            border: 2px solid var(--pine);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--pine);
            padding-bottom: 10px;
        }

        .modal-title {
            color: var(--soft-mint);
            font-size: 18px;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--granite);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--soft-mint);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: var(--soft-mint);
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--pine);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--soft-mint);
        }

        .coordinates-example {
            font-size: 12px;
            color: var(--granite);
            margin-top: 5px;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            flex: 1;
            padding: 12px;
            background: var(--telegram-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #0077b5;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: var(--card-bg);
            color: var(--granite);
            border: 1px solid var(--pine);
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: var(--pine);
            color: white;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            color: var(--soft-mint);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            margin-top: 15px;
        }

        .detected-info {
    margin: 15px 0;
    animation: fadeIn 0.5s ease;
    }

    .coordinates-example a {
        color: var(--soft-mint);
        text-decoration: none;
        font-weight: bold;
    }

    .coordinates-example a:hover {
        text-decoration: underline;
    }

    .loading-detection {
        text-align: center;
        padding: 15px;
        color: var(--soft-mint);
    }

    .loading-detection .loader-small {
        width: 20px;
        height: 20px;
        border: 2px solid var(--pine);
        border-top: 2px solid var(--soft-mint);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
    }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚ö° Buscador Honduras - Instant√°neo</h1>
        <p>Resultados en tiempo real con cache local</p>
    </div>

    <div class="search-section">
        <input type="text" id="mainSearch" class="search-input" 
               placeholder="Buscar colonia, barrio, aldea, caser√≠o...">
        <div class="search-info">
            <div id="cacheStatus"></div>
            <div id="searchStatus">Escriba para buscar</div>
        </div>
    </div>

    <div class="quick-filters" id="quickFilters"></div>

    <div id="resultsContainer" class="results-list"></div>
    
    <div id="resultsStats" class="results-stats" style="display:none;"></div>

    <a id="mapSearchLink" href="#" target="_blank" class="map-search-link" style="display:none;">
        üîç ¬øNo est√° la que buscabas? Buscar en Google Maps
    </a>
</div>

<!-- Bot√≥n flotante para agregar direcciones -->
<button class="floating-btn" id="openModalBtn">+</button>

<!-- Modal para agregar nueva direcci√≥n -->
<div class="modal-overlay" id="addLocationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üìç Agregar Nueva Direcci√≥n</h3>
            <button class="close-modal" id="closeModalBtn">&times;</button>
        </div>
        
        <form id="locationForm">
            <div class="form-group">
                <label class="form-label">Coordenadas (lat, lon):</label>
                <input type="text" class="form-input" id="locationCoords" 
                       placeholder="Ej: 15.527522, -88.061812" required>
                <div class="coordinates-example">
                    <strong>üìå ¬øC√≥mo obtener coordenadas?</strong><br>
                    1. Abre <a href="https://maps.google.com" target="_blank">Google Maps</a><br>
                    2. Busca el lugar en Honduras<br>
                    3. Haz clic derecho ‚Üí "¬øQu√© hay aqu√≠?"<br>
                    4. Copia los n√∫meros (ej: 15.527522, -88.061812)<br>
                    <em>Formato: latitud, longitud</em>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Nombre del lugar (opcional):</label>
                <input type="text" class="form-input" id="locationName" 
                       placeholder="Ej: Mi casa, Tienda la esquina, etc.">
                <small style="color: var(--granite); font-size: 11px;">
                    Si no pones nombre, usaremos el de Google Maps
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tipo de lugar:</label>
                <select class="form-input" id="locationType">
                    <option value="colonia">Colonia</option>
                    <option value="barrio">Barrio</option>
                    <option value="aldea">Aldea</option>
                    <option value="caserio">Caser√≠o</option>
                    <option value="municipio">Municipio</option>
                    <option value="punto_interes">Punto de Inter√©s</option>
                    <option value="casa">Casa</option>
                    <option value="negocio">Negocio</option>
                </select>
            </div>
            
            <div class="detected-info" id="detectedInfo" style="display: none;">
                <div class="warning-note" style="background: rgba(52, 103, 92, 0.1); border-color: var(--pine);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üîç</span>
                        <div>
                            <strong>Informaci√≥n detectada:</strong><br>
                            <span id="detectedAddress">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="success-message" id="successMessage">
                ‚úÖ Solicitud enviada para aprobaci√≥n
            </div>
            
            <div class="form-buttons">
                <button type="button" class="btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="button" class="btn-secondary" id="detectBtn" style="background: var(--pine);">
                    üîç Detectar Direcci√≥n
                </button>
                <button type="submit" class="btn-primary" id="submitBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.98 1.26-5.6 3.68-.53.37-1.01.56-1.45.54-.48-.02-1.4-.27-2.08-.5-.84-.27-1.51-.42-1.45-.88.03-.24.27-.49.74-.75 2.87-1.25 4.78-2.08 5.74-2.5 2.78-1.16 3.36-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .05z"/>
                    </svg>
                    Enviar a Telegram
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // ========== CONFIGURACI√ìN QUE DEBES MODIFICAR ==========
    // === L√çNEA 682: CAMBIA ESTOS VALORES ===
    const TELEGRAM_BOT_TOKEN = '8554913344:AAFx8KcrJhXDLuB7ufOXhVqf9y8CqtzjLW4';  // Reemplaza con tu token real
    const TELEGRAM_CHAT_ID = '5770086010';      // Reemplaza con tu chat ID
    const RENDER_APP_URL = 'https://tu-app-en-render.onrender.com'; // URL de tu app en Render
    
    // === L√çNEA 688: Tu repositorio de GitHub ===
    const GITHUB_USER = 'tu_usuario_github';         // Tu nombre de usuario de GitHub
    const GITHUB_REPO = 'tu_repositorio';            // Nombre de tu repositorio
    
    // ========== ALMACENAMIENTO ==========
    const searchCache = new Map();
    const CACHE_DURATION = 24 * 60 * 60 * 1000;
    
    // Base de datos local
    let localDatabase = {};

    // ========== FUNCIONES DE CACHE ==========
    function loadCacheFromStorage() {
        try {
            const savedCache = localStorage.getItem('hnSearchCache');
            if (savedCache) {
                const parsed = JSON.parse(savedCache);
                const now = Date.now();
                
                Object.entries(parsed).forEach(([key, data]) => {
                    if (now - data.timestamp < CACHE_DURATION) {
                        searchCache.set(key, data.results);
                    }
                });
                
                updateCacheStatus();
            }
        } catch (e) {
            console.log("Error cargando cache:", e);
        }
    }

    function saveCacheToStorage() {
        try {
            const cacheObj = {};
            const now = Date.now();
            
            searchCache.forEach((results, key) => {
                cacheObj[key] = {
                    results: results,
                    timestamp: now
                };
            });
            
            localStorage.setItem('hnSearchCache', JSON.stringify(cacheObj));
        } catch (e) {
            console.log("Error guardando cache:", e);
        }
    }

    // ========== CARGAR BASE DE DATOS DESDE GITHUB ==========
    async function loadDatabaseFromGitHub() {
        try {
            const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/locations.json`);
            if (response.ok) {
                const data = await response.json();
                localDatabase = data;
                console.log('Base de datos cargada:', Object.keys(data).length, 'ubicaciones');
                updateCacheStatus();
            } else {
                console.log('Usando base de datos local inicial');
                // Base de datos inicial por defecto
                localDatabase = {
                    "colonia_kennedy": { name: "Colonia Kennedy", lat: 14.0833, lon: -87.1833, municipio: "Tegucigalpa", departamento: "Francisco Moraz√°n", type: "colonia" },
                    "colonia_satelite": { name: "Colonia Sat√©lite", lat: 15.5200, lon: -88.0400, municipio: "San Pedro Sula", departamento: "Cort√©s", type: "colonia" },
                    "colonia_palmira": { name: "Colonia Palmira", lat: 14.1000, lon: -87.2000, municipio: "Tegucigalpa", departamento: "Francisco Moraz√°n", type: "colonia" },
                    "san_pedro_sula": { name: "San Pedro Sula", lat: 15.5000, lon: -88.0300, municipio: "San Pedro Sula", departamento: "Cort√©s", type: "municipio" },
                    "tegucigalpa": { name: "Tegucigalpa", lat: 14.0818, lon: -87.2068, municipio: "Tegucigalpa", departamento: "Francisco Moraz√°n", type: "municipio" }
                };
            }
        } catch (error) {
            console.error('Error cargando base de datos:', error);
        }
    }

    // ========== INICIALIZACI√ìN ==========
    async function initializeApp() {
        loadCacheFromStorage();
        setupQuickFilters();
        await loadDatabaseFromGitHub();
        showEmptyState();
    }

    // ========== FUNCIONES DE B√öSQUEDA ==========
    function normalizeQuery(query) {
        return query
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, '')
            .trim();
    }

    function searchLocalFast(query) {
        const normalized = normalizeQuery(query);
        const results = [];
        
        // Buscar en base local
        Object.entries(localDatabase).forEach(([key, location]) => {
            if (key.includes(normalized) || normalized.includes(key) || 
                location.name.toLowerCase().includes(normalized)) {
                results.push({
                    ...location,
                    source: 'official',
                    score: key === normalized ? 100 : 50
                });
            }
        });
        
        return results.sort((a, b) => b.score - a.score);
    }

    async function searchAPI(query) {
        const cacheKey = `api_${normalizeQuery(query)}`;
        
        if (searchCache.has(cacheKey)) {
            return searchCache.get(cacheKey);
        }
        
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?` +
                `q=${encodeURIComponent(query + ' Honduras')}` +
                `&format=json&addressdetails=1&limit=20&countrycodes=hn` +
                `&dedupe=1&bounded=1&viewbox=-89.5,12.0,-83.0,17.0`
            );
            
            if (!response.ok) throw new Error('API Error');
            
            const data = await response.json();
            const processed = processAPIData(data);
            
            searchCache.set(cacheKey, processed);
            saveCacheToStorage();
            updateCacheStatus();
            
            return processed;
        } catch (error) {
            console.error("API Error:", error);
            return [];
        }
    }

    function processAPIData(data) {
        return data.map(item => {
            const address = item.address || {};
            
            let type = 'ubicaci√≥n';
            if (item.type === 'administrative') {
                if (address.city || address.town) type = 'municipio';
                else if (address.state) type = 'departamento';
            } else if (address.suburb) {
                type = address.suburb.includes('Colonia') ? 'colonia' : 'barrio';
            } else if (address.village) {
                type = 'aldea';
            } else if (address.hamlet) {
                type = 'caser√≠o';
            }
            
            return {
                name: item.display_name.split(',')[0],
                type: type,
                lat: parseFloat(item.lat),
                lon: parseFloat(item.lon),
                municipio: address.city || address.town || address.municipality || '',
                departamento: address.state || address.county || '',
                aldea: address.village || address.hamlet || '',
                barrio_colonia: address.suburb || address.neighbourhood || '',
                full_address: item.display_name,
                source: 'api',
                importance: item.importance || 0
            };
        });
    }

    function createGoogleMapsUrl(location) {
        let searchQuery = '';
        
        if (location.barrio_colonia) {
            searchQuery = `${location.barrio_colonia}, `;
        } else if (location.name) {
            searchQuery = `${location.name}, `;
        }
        
        if (location.municipio) {
            searchQuery += `${location.municipio}, `;
        }
        
        if (location.departamento) {
            searchQuery += `${location.departamento}, `;
        }
        
        searchQuery += 'Honduras';
        
        const encodedQuery = encodeURIComponent(searchQuery);
        return `https://www.google.com/maps/search/?api=1&query=${encodedQuery}`;
    }

    // ========== INTERFAZ Y EVENTOS ==========
    let searchTimeout;
    let lastQuery = '';
    let isSearching = false;

    document.getElementById('mainSearch').addEventListener('input', function(e) {
        const query = e.target.value.trim();
        if (query === lastQuery) return;
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            showEmptyState();
            document.getElementById('mapSearchLink').style.display = 'none';
            return;
        }
        
        lastQuery = query;
        document.getElementById('searchStatus').textContent = `Buscando: "${query}"`;
        
        const mapLink = document.getElementById('mapSearchLink');
        mapLink.href = `https://www.google.com/maps/search/${encodeURIComponent(query + ' Honduras')}`;
        mapLink.style.display = 'block';
        
        const localResults = searchLocalFast(query);
        if (localResults.length > 0) {
            displayResults(localResults, true);
        }
        
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });

    async function performSearch(query) {
        if (isSearching) return;
        
        isSearching = true;
        showLoading();
        
        try {
            const apiResults = await searchAPI(query);
            const localResults = searchLocalFast(query);
            const allResults = [...localResults, ...apiResults];
            const uniqueResults = removeDuplicates(allResults);
            
            displayResults(uniqueResults, false);
            
            const fromCache = searchCache.has(`api_${normalizeQuery(query)}`);
            document.getElementById('searchStatus').textContent = 
                `${uniqueResults.length} resultados ${fromCache ? '(cache)' : '(en l√≠nea)'}`;
                
        } catch (error) {
            document.getElementById('searchStatus').textContent = 'Error en b√∫squeda';
        } finally {
            isSearching = false;
        }
    }

    function removeDuplicates(results) {
        const seen = new Set();
        const unique = [];
        
        results.forEach(item => {
            const key = `${normalizeQuery(item.name)}_${item.lat.toFixed(3)}_${item.lon.toFixed(3)}`;
            if (!seen.has(key)) {
                seen.add(key);
                unique.push(item);
            }
        });
        
        return unique.sort((a, b) => {
            const aScore = (a.source === 'official' ? 100 : 0) + (a.importance || 0);
            const bScore = (b.source === 'official' ? 100 : 0) + (b.importance || 0);
            return bScore - aScore;
        });
    }

    function showLoading() {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `
            <div class="searching">
                <div class="loader"></div>
                <div>Buscando en servidores...</div>
            </div>
        `;
    }

    function showEmptyState() {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">üîç</div>
                <p>Escriba el nombre de una colonia, barrio o aldea</p>
            </div>
        `;
        document.getElementById('searchStatus').textContent = 'Listo para buscar';
        document.getElementById('resultsStats').style.display = 'none';
    }

    function displayResults(results, fromLocalOnly = false) {
        const container = document.getElementById('resultsContainer');
        const stats = document.getElementById('resultsStats');
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">ü§î</div>
                    <p>No se encontraron resultados</p>
                    ${fromLocalOnly ? '<p style="font-size:11px;color:var(--soft-mint)">Buscando en servidores en l√≠nea...</p>' : ''}
                </div>
            `;
            stats.style.display = 'none';
            return;
        }
        
        const grouped = {};
        results.forEach(item => {
            const key = normalizeQuery(item.name);
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(item);
        });
        
        let html = '';
        let totalCards = 0;
        
        Object.entries(grouped).forEach(([name, locations]) => {
            const isRepeated = locations.length > 1;
            
            locations.forEach((loc, index) => {
                totalCards++;
                
                let identifier = '';
                if (isRepeated && loc.municipio) {
                    identifier = ` (${loc.municipio})`;
                } else if (isRepeated) {
                    identifier = ` #${index + 1}`;
                }
                
                const mapUrl = createGoogleMapsUrl(loc);
                
                html += `
                    <div class="location-card ${isRepeated ? 'repeated' : ''}" 
                         onclick="window.open('${mapUrl}', '_blank')">
                        
                        <span class="location-type">${loc.type}</span>
                        
                        <span class="place-name">
                            ${loc.name}${identifier}
                            ${loc.source === 'official' ? '<span style="font-size:10px;color:var(--success);margin-left:5px;">‚ö°</span>' : ''}
                        </span>
                        
                        <div class="location-hierarchy">
                            ${loc.municipio ? `
                                <div class="hierarchy-item">
                                    <span class="hierarchy-label">Municipio:</span>
                                    <span class="hierarchy-value">${loc.municipio}</span>
                                </div>
                            ` : ''}
                            
                            ${loc.departamento ? `
                                <div class="hierarchy-item">
                                    <span class="hierarchy-label">Departamento:</span>
                                    <span class="hierarchy-value">${loc.departamento}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="coordinates-row">
                            <span class="coords-display">
                                üìç ${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}
                            </span>
                            
                            <div class="action-buttons">
                                <button class="btn-action btn-map" 
                                        onclick="event.stopPropagation(); window.open('${mapUrl}', '_blank')">
                                    üó∫Ô∏è Ver en Maps
                                </button>
                                <button class="btn-action btn-copy" 
                                        onclick="event.stopPropagation(); copyCoords(${loc.lat}, ${loc.lon}, this)">
                                    üìã Copiar
                                </button>
                            </div>
                        </div>
                        
                        ${isRepeated ? `
                            <div class="warning-note">
                                ‚ö†Ô∏è ${locations.length} ubicaciones con este nombre
                            </div>
                        ` : ''}
                    </div>
                `;
            });
        });
        
        container.innerHTML = html;
        
        const uniqueNames = Object.keys(grouped).length;
        stats.innerHTML = `
            ${totalCards} ubicaciones ‚Ä¢ ${uniqueNames} nombres diferentes<br>
            <small>‚ö° = oficial</small>
        `;
        stats.style.display = 'block';
    }

    function copyCoords(lat, lon, button) {
        const text = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        navigator.clipboard.writeText(text).then(() => {
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ Copiado';
            button.classList.add('success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('success');
            }, 1500);
        });
    }

    function updateCacheStatus() {
        const status = document.getElementById('cacheStatus');
        const totalLocations = Object.keys(localDatabase).length;
        status.textContent = `Cache: ${searchCache.size} b√∫squedas ‚Ä¢ ${totalLocations} ubicaciones`;
        status.className = 'cache-indicator';
    }

    function setupQuickFilters() {
        const filters = [
            {text: "Colonias Populares", search: "Colonia"},
            {text: "Barrios", search: "Barrio"},
            {text: "Municipios", search: "Municipio Honduras"},
            {text: "Aldeas", search: "Aldea Honduras"},
            {text: "Tegucigalpa", search: "Tegucigalpa"},
            {text: "San Pedro Sula", search: "San Pedro Sula"},
            {text: "La Ceiba", search: "La Ceiba"}
        ];
        
        const container = document.getElementById('quickFilters');
        filters.forEach(filter => {
            const btn = document.createElement('button');
            btn.className = 'quick-filter';
            btn.textContent = filter.text;
            btn.onclick = () => {
                document.getElementById('mainSearch').value = filter.search;
                document.getElementById('mainSearch').dispatchEvent(new Event('input'));
            };
            container.appendChild(btn);
        });
    }

    // ========== SISTEMA PARA AGREGAR DIRECCIONES ==========
const modal = document.getElementById('addLocationModal');
const openBtn = document.getElementById('openModalBtn');
const closeBtn = document.getElementById('closeModalBtn');
const cancelBtn = document.getElementById('cancelBtn');
const form = document.getElementById('locationForm');
const successMessage = document.getElementById('successMessage');
const detectBtn = document.getElementById('detectBtn');
const detectedInfo = document.getElementById('detectedInfo');

// Datos detectados
let detectedData = {
    municipio: '',
    departamento: '',
    fullAddress: '',
    placeName: ''
};

openBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    form.reset();
    successMessage.style.display = 'none';
    detectedInfo.style.display = 'none';
    detectedData = { municipio: '', departamento: '', fullAddress: '', placeName: '' };
});

closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
});

cancelBtn.addEventListener('click', () => {
    modal.style.display = 'none';
});

modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        modal.style.display = 'none';
    }
});

// ========== DETECCI√ìN AUTOM√ÅTICA DE DIRECCI√ìN ==========
detectBtn.addEventListener('click', async () => {
    const coordsInput = document.getElementById('locationCoords').value.trim();
    
    if (!coordsInput) {
        alert('‚ö†Ô∏è Por favor ingresa las coordenadas primero');
        return;
    }
    
    // Validar formato de coordenadas
    const coords = coordsInput.split(',').map(c => c.trim());
    if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
        alert('‚ùå Formato de coordenadas inv√°lido. Usa: latitud, longitud');
        return;
    }
    
    const lat = parseFloat(coords[0]);
    const lon = parseFloat(coords[1]);
    
    // Validar que est√©n en Honduras (aproximadamente)
    if (lat < 12.0 || lat > 17.0 || lon > -83.0 || lon < -89.5) {
        if (!confirm('‚ö†Ô∏è Las coordenadas parecen fuera de Honduras. ¬øContinuar?')) {
            return;
        }
    }
    
    // Mostrar carga
    detectedInfo.innerHTML = `
        <div class="loading-detection">
            <div class="loader-small"></div>
            Detectando direcci√≥n en Google Maps...
        </div>
    `;
    detectedInfo.style.display = 'block';
    
    try {
        // Usar Nominatim (OpenStreetMap) para reverso geocoding
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?` +
            `lat=${lat}&lon=${lon}&` +
            `format=json&addressdetails=1&zoom=18&accept-language=es`
        );
        
        if (!response.ok) throw new Error('Error en la API');
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        const address = data.address || {};
        
        // Extraer municipio y departamento de Honduras
        let municipio = '';
        let departamento = '';
        let placeName = data.display_name.split(',')[0];
        
        // Mapeo de campos de OpenStreetMap para Honduras
        if (address.city) {
            municipio = address.city;
        } else if (address.town) {
            municipio = address.town;
        } else if (address.village) {
            municipio = address.village;
        } else if (address.municipality) {
            municipio = address.municipality;
        }
        
        if (address.state) {
            departamento = address.state;
        } else if (address.county) {
            departamento = address.county;
        }
        
        // Si no se detect√≥ municipio, usar un gen√©rico
        if (!municipio && !departamento) {
            // Intentar con API de Google Maps (fallback)
            const googleResponse = await fetch(
                `https://maps.googleapis.com/maps/api/geocode/json?` +
                `latlng=${lat},${lon}&key=AIzaSyDummyKey&language=es`
            ).catch(() => null);
            
            if (googleResponse && googleResponse.ok) {
                const googleData = await googleResponse.json();
                if (googleData.results && googleData.results[0]) {
                    const components = googleData.results[0].address_components;
                    
                    components.forEach(component => {
                        if (component.types.includes('administrative_area_level_2')) {
                            municipio = component.long_name;
                        }
                        if (component.types.includes('administrative_area_level_1')) {
                            departamento = component.long_name;
                        }
                    });
                }
            }
        }
        
        // Guardar datos detectados
        detectedData = {
            municipio: municipio || 'Desconocido',
            departamento: departamento || 'Desconocido',
            fullAddress: data.display_name,
            placeName: placeName
        };
        
        // Actualizar interfaz
        detectedInfo.innerHTML = `
            <div class="warning-note" style="background: rgba(52, 103, 92, 0.1); border-color: var(--pine);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 18px;">‚úÖ</span>
                    <div>
                        <strong>Direcci√≥n detectada:</strong><br>
                        <span id="detectedAddress">
                            ${municipio ? `<strong>Municipio:</strong> ${municipio}<br>` : ''}
                            ${departamento ? `<strong>Departamento:</strong> ${departamento}<br>` : ''}
                            ${placeName ? `<strong>Lugar:</strong> ${placeName}` : ''}
                        </span>
                    </div>
                </div>
            </div>
        `;
        
        // Si no hay nombre ingresado, sugerir el detectado
        const nameInput = document.getElementById('locationName');
        if (!nameInput.value.trim() && placeName) {
            nameInput.value = placeName;
        }
        
        // Auto-seleccionar tipo seg√∫n lo detectado
        const typeSelect = document.getElementById('locationType');
        const lowerAddress = data.display_name.toLowerCase();
        
        if (lowerAddress.includes('colonia')) {
            typeSelect.value = 'colonia';
        } else if (lowerAddress.includes('barrio')) {
            typeSelect.value = 'barrio';
        } else if (lowerAddress.includes('aldea') || lowerAddress.includes('caser√≠o')) {
            typeSelect.value = 'aldea';
        } else if (lowerAddress.includes('municipio')) {
            typeSelect.value = 'municipio';
        }
        
    } catch (error) {
        console.error('Error en detecci√≥n:', error);
        detectedInfo.innerHTML = `
            <div class="warning-note">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 18px;">‚ö†Ô∏è</span>
                    <div>
                        <strong>No se pudo detectar la direcci√≥n autom√°ticamente</strong><br>
                        <span style="font-size: 12px;">Puedes enviarla igual y la aprobaremos manualmente</span>
                    </div>
                </div>
            </div>
        `;
        detectedInfo.style.display = 'block';
        
        // Datos por defecto
        detectedData = {
            municipio: 'Por determinar',
            departamento: 'Por determinar',
            fullAddress: 'Direcci√≥n no detectada autom√°ticamente',
            placeName: 'Ubicaci√≥n sin nombre'
        };
    }
});

// ========== ENVIAR A TELEGRAM ==========
async function sendToTelegram(locationData) {
    try {
        // Usar los datos detectados si est√°n disponibles
        const finalData = {
            name: locationData.name || detectedData.placeName || 'Ubicaci√≥n sin nombre',
            coords: locationData.coords,
            municipio: detectedData.municipio || 'Por determinar',
            departamento: detectedData.departamento || 'Por determinar',
            type: locationData.type,
            detected: detectedData.fullAddress || 'No detectado'
        };
        
        // M√©todo 1: Intentar enviar a trav√©s de Render
        if (RENDER_APP_URL && RENDER_APP_URL !== 'https://tu-app-en-render.onrender.com') {
            try {
                const response = await fetch(`${RENDER_APP_URL}/send-notification`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        location: finalData,
                        telegram_chat_id: TELEGRAM_CHAT_ID
                    })
                });
                
                if (response.ok) {
                    return {success: true, data: finalData};
                }
            } catch (error) {
                console.log('Fallando a m√©todo directo:', error);
            }
        }
        
        // M√©todo 2: Env√≠o directo a Telegram API
        const message = `üìç *NUEVA SOLICITUD DE DIRECCI√ìN - DETECTADA AUTOM√ÅTICAMENTE*

*Coordenadas:* \`${finalData.coords}\`
*Nombre:* ${finalData.name}
*Municipio detectado:* ${finalData.municipio}
*Departamento detectado:* ${finalData.departamento}
*Tipo:* ${finalData.type}

*Direcci√≥n completa:*
${finalData.detected}

*Para aprobar, responde:*
‚úÖ aprobar
*Para rechazar:*
‚ùå rechazar`;

        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            })
        });

        return {success: response.ok, data: finalData};
        
    } catch (error) {
        console.error('Error enviando a Telegram:', error);
        return {success: false, data: null};
    }
}

// ========== MANEJAR ENV√çO DEL FORMULARIO ==========
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '‚è≥ Detectando y enviando...';
    submitBtn.disabled = true;
    
    try {
        const locationData = {
            name: document.getElementById('locationName').value.trim(),
            coords: document.getElementById('locationCoords').value.trim(),
            type: document.getElementById('locationType').value
        };
        
        // Validar coordenadas
        const coords = locationData.coords.split(',').map(c => c.trim());
        if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
            throw new Error('Formato de coordenadas inv√°lido. Usa: lat, lon');
        }
        
        // Si no se detect√≥ autom√°ticamente, intentar detectar ahora
        if (!detectedData.municipio || detectedData.municipio === 'Por determinar') {
            await detectBtn.click();
            // Esperar un poco para la detecci√≥n
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        // Enviar a Telegram
        const result = await sendToTelegram(locationData);
        
        if (result.success) {
            successMessage.innerHTML = `
                ‚úÖ <strong>Solicitud enviada para aprobaci√≥n</strong><br>
                <small style="font-size: 11px;">
                    Municipio: ${result.data.municipio}<br>
                    Departamento: ${result.data.departamento}
                </small>
            `;
            successMessage.style.display = 'block';
            submitBtn.innerHTML = '‚úÖ ¬°Enviado!';
            
            setTimeout(() => {
                modal.style.display = 'none';
                form.reset();
                detectedInfo.style.display = 'none';
                detectedData = { municipio: '', departamento: '', fullAddress: '', placeName: '' };
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 3000);
            
        } else {
            throw new Error('No se pudo enviar la solicitud');
        }
        
    } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

    // ========== FUNCI√ìN PARA ACTUALIZAR BASE DE DATOS ==========
    async function refreshDatabase() {
        await loadDatabaseFromGitHub();
        const currentQuery = document.getElementById('mainSearch').value.trim();
        if (currentQuery.length >= 2) {
            performSearch(currentQuery);
        }
        alert('‚úÖ Base de datos actualizada');
    }

    // ========== INICIALIZAR APLICACI√ìN ==========
    initializeApp();
    
    // Hacer refreshDatabase accesible globalmente
    window.refreshDatabase = refreshDatabase;
</script>
</body>
</html>